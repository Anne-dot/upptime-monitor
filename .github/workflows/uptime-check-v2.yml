name: Uptime Check v2

# ============================================
# Single Source of Truth: sites.json
# Retry: 3 katset enne alerti
# ============================================

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

env:
  TEST_MODE: "true"
  TECH_EMAIL: "ruusmann@gmail.com"

jobs:
  # ============================================
  # JOB 1: Kontrolli koiki saite
  # ============================================
  check:
    runs-on: ubuntu-latest
    outputs:
      errors: ${{ steps.check.outputs.errors }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Kontrolli saite
        id: check
        run: |
          echo "========================================"
          echo "Uptime Check v2 - $(date)"
          echo "========================================"

          ERRORS="[]"

          # Loe sites.json
          SITE_COUNT=$(jq length sites.json)

          for i in $(seq 0 $((SITE_COUNT - 1))); do
            name=$(jq -r ".[$i].name" sites.json)
            url=$(jq -r ".[$i].url" sites.json)
            is_php=$(jq -r ".[$i].is_php" sites.json)
            check_ssl=$(jq -r ".[$i].ssl" sites.json)
            emails=$(jq -r ".[$i].emails" sites.json)

            echo ""
            echo "--- $name ---"

            reason=""

            # ========== RETRY LOOGIKA (3 katset) ==========
            for attempt in 1 2 3; do
              reason=""

              # 1. Lehe laadimine + HTTP staatus + aeg UHES paringus
              set +e
              full_response=$(curl -sL -w "\n%{http_code}\n%{time_total}" --max-time 30 "$url" 2>&1)
              curl_exit=$?
              set -e

              # Eralda: sisu, HTTP staatus, response time
              time_total=$(echo "$full_response" | tail -1)
              status=$(echo "$full_response" | tail -2 | head -1)
              response=$(echo "$full_response" | sed -n '1,/^[0-9]\{3\}$/{ /^[0-9]\{3\}$/d; p; }')

              # Curl exit koodide eristamine
              if [ $curl_exit -eq 28 ]; then
                reason="Timeout (>30s) - leht aeglane"
              elif [ $curl_exit -eq 6 ]; then
                reason="DNS viga - host not found"
              elif [ $curl_exit -eq 7 ]; then
                reason="Uhendus ebaonnestus - server maas?"
              elif [ $curl_exit -ne 0 ]; then
                reason="Curl viga (exit $curl_exit)"
              elif [ "$status" != "200" ]; then
                reason="HTTP viga: $status"
              else
                echo "OK: HTTP $status (${time_total}s)"

                # 2. PHP vead (taipsem regex)
                if [ "$is_php" = "true" ]; then
                  if echo "$response" | grep -qE "(<b>Fatal error</b>|<b>Parse error</b>|<b>Warning</b>)"; then
                    reason="PHP viga lehel"
                  fi
                fi

                # 3. SSL kontroll
                if [ -z "$reason" ] && [ "$check_ssl" = "true" ]; then
                  host=$(echo "$url" | sed 's|https://||' | sed 's|/.*||')
                  set +e
                  expiry=$(echo | openssl s_client -connect "$host:443" -servername "$host" 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
                  set -e
                  if [ -n "$expiry" ]; then
                    expiry_epoch=$(date -d "$expiry" +%s 2>/dev/null || echo "0")
                    now_epoch=$(date +%s)
                    if [ "$expiry_epoch" != "0" ]; then
                      days_left=$(( (expiry_epoch - now_epoch) / 86400 ))
                      if [ $days_left -le 7 ]; then
                        reason="SSL sertifikaat aegub $days_left paeva parast"
                      fi
                    fi
                  fi
                fi
              fi

              # Kui OK, lopeta retry
              if [ -z "$reason" ]; then
                echo "OK (katse $attempt)"
                break
              fi

              # Kui viga ja pole viimane katse, oota
              if [ $attempt -lt 3 ]; then
                echo "Katse $attempt ebaonnestus: $reason - ootan 10s..."
                sleep 10
              fi
            done

            # Lopptulemus
            if [ -n "$reason" ]; then
              echo "VIGA (parast 3 katset): $reason"
              # Lisa error JSON massiivi
              ERRORS=$(echo "$ERRORS" | jq -c ". + [{\"name\": \"$name\", \"url\": \"$url\", \"reason\": \"$reason\", \"emails\": \"$emails\"}]")
            else
              echo "KOIK OK"
            fi
          done

          echo ""
          echo "========================================"
          echo "Errors: $ERRORS"
          echo "========================================"

          echo "errors=$ERRORS" >> $GITHUB_OUTPUT

  # ============================================
  # JOB 2: Saada teavitused (dunaamiline matrix)
  # ============================================
  notify:
    needs: check
    if: needs.check.outputs.errors != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        error: ${{ fromJSON(needs.check.outputs.errors) }}
    steps:
      - name: Teavitus - ${{ matrix.error.name }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "⚠️ ${{ matrix.error.name }} probleem"
          to: ${{ env.TEST_MODE == 'true' && env.TECH_EMAIL || matrix.error.emails }}
          from: Veebilehtede seire
          body: |
            ${{ matrix.error.name }} ei toota!

            Pohjus: ${{ matrix.error.reason }}

            Kontrolli lehte: ${{ matrix.error.url }}
