name: Uptime Check v2

on:
  # schedule:
  #   - cron: "*/30 * * * *"
  workflow_dispatch:

env:
  TEST_MODE: "false"
  TECH_EMAIL: "ruusmann@gmail.com"

jobs:
  check-all:
    runs-on: ubuntu-latest
    outputs:
      nirgu_failed: ${{ steps.check.outputs.nirgu_failed }}
      nirgu_reason: ${{ steps.check.outputs.nirgu_reason }}
      birdbusters_failed: ${{ steps.check.outputs.birdbusters_failed }}
      birdbusters_reason: ${{ steps.check.outputs.birdbusters_reason }}
      sharpy_failed: ${{ steps.check.outputs.sharpy_failed }}
      sharpy_reason: ${{ steps.check.outputs.sharpy_reason }}
      linnupeletaja_failed: ${{ steps.check.outputs.linnupeletaja_failed }}
      linnupeletaja_reason: ${{ steps.check.outputs.linnupeletaja_reason }}
      lasteaiapildid_failed: ${{ steps.check.outputs.lasteaiapildid_failed }}
      lasteaiapildid_reason: ${{ steps.check.outputs.lasteaiapildid_reason }}
      athliit_failed: ${{ steps.check.outputs.athliit_failed }}
      athliit_reason: ${{ steps.check.outputs.athliit_reason }}
    steps:
      - name: Check all sites
        id: check
        run: |
          check_site() {
            local name="$1"
            local url="$2"
            local is_php="$3"
            local check_ssl="$4"
            local var_name="$5"
            
            echo "--- $name ---"
            local reason=""
            
            if ! response=$(curl -sL --max-time 30 "$url" 2>&1); then
              reason="Timeout - leht ei vastanud 30 sekundi jooksul"
            else
              status=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 30 "$url")
              if [ "$status" != "200" ]; then
                reason="HTTP viga: $status"
              elif [ "$is_php" = "true" ] && echo "$response" | grep -qiE "(Fatal error|Parse error|Warning:|Exception)"; then
                reason="PHP viga lehel"
              elif [ ${#response} -lt 500 ]; then
                reason="Tuhi voi liiga luhike vastus (${#response} bytes)"
              elif [ "$check_ssl" = "true" ]; then
                host=$(echo "$url" | sed 's|https://||' | sed 's|/.*||')
                expiry=$(echo | openssl s_client -connect "$host:443" -servername "$host" 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
                if [ -n "$expiry" ]; then
                  expiry_epoch=$(date -d "$expiry" +%s 2>/dev/null || echo "0")
                  now_epoch=$(date +%s)
                  if [ "$expiry_epoch" != "0" ]; then
                    days_left=$(( (expiry_epoch - now_epoch) / 86400 ))
                    if [ $days_left -le 7 ]; then
                      reason="SSL aegub $days_left paeva parast"
                    fi
                  fi
                fi
              fi
            fi
            
            if [ -n "$reason" ]; then
              echo "${var_name}_failed=true" >> $GITHUB_OUTPUT
              echo "${var_name}_reason=$reason" >> $GITHUB_OUTPUT
              echo "FAIL: $reason"
            else
              echo "${var_name}_failed=false" >> $GITHUB_OUTPUT
              echo "OK"
            fi
          }
          
          check_site "nirgu.ee" "https://nirgu.ee" "true" "true" "nirgu"
          check_site "birdbusters.eu" "https://birdbusters.eu" "true" "true" "birdbusters"
          check_site "sharpy.ee" "https://sharpy.ee" "true" "true" "sharpy"
          check_site "linnupeletaja.ee" "http://linnupeletaja.ee" "true" "false" "linnupeletaja"
          check_site "lasteaiapildid.ee" "https://lasteaiapildid.ee" "false" "true" "lasteaiapildid"
          check_site "athliit.ee" "https://athliit.ee" "true" "true" "athliit"

      - name: Alert nirgu.ee
        if: steps.check.outputs.nirgu_failed == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[ALERT] nirgu.ee probleem"
          to: info@nirgu.ee,${{ env.TECH_EMAIL }}
          from: Veebilehtede seire
          body: |
            nirgu.ee ei toota!
            Pohjus: ${{ steps.check.outputs.nirgu_reason }}
            Kontrolli: https://nirgu.ee

      - name: Alert birdbusters.eu
        if: steps.check.outputs.birdbusters_failed == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[ALERT] birdbusters.eu probleem"
          to: info@birdbusters.eu,${{ env.TECH_EMAIL }}
          from: Veebilehtede seire
          body: |
            birdbusters.eu ei toota!
            Pohjus: ${{ steps.check.outputs.birdbusters_reason }}
            Kontrolli: https://birdbusters.eu

      - name: Alert sharpy.ee
        if: steps.check.outputs.sharpy_failed == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[ALERT] sharpy.ee probleem"
          to: info@sharpy.ee,${{ env.TECH_EMAIL }}
          from: Veebilehtede seire
          body: |
            sharpy.ee ei toota!
            Pohjus: ${{ steps.check.outputs.sharpy_reason }}
            Kontrolli: https://sharpy.ee

      - name: Alert linnupeletaja.ee
        if: steps.check.outputs.linnupeletaja_failed == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[ALERT] linnupeletaja.ee probleem"
          to: info@nirgu.ee,${{ env.TECH_EMAIL }}
          from: Veebilehtede seire
          body: |
            linnupeletaja.ee ei toota!
            Pohjus: ${{ steps.check.outputs.linnupeletaja_reason }}
            Kontrolli: http://linnupeletaja.ee

      - name: Alert lasteaiapildid.ee
        if: steps.check.outputs.lasteaiapildid_failed == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[ALERT] lasteaiapildid.ee probleem"
          to: info@lasteaiapildid.ee,${{ env.TECH_EMAIL }}
          from: Veebilehtede seire
          body: |
            lasteaiapildid.ee ei toota!
            Pohjus: ${{ steps.check.outputs.lasteaiapildid_reason }}
            Kontrolli: https://lasteaiapildid.ee

      - name: Alert athliit.ee
        if: steps.check.outputs.athliit_failed == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[ALERT] athliit.ee probleem"
          to: anne.ruusmann@athliit.ee,info@athliit.ee,kerstenkorge@athliit.ee,${{ env.TECH_EMAIL }}
          from: Veebilehtede seire
          body: |
            athliit.ee ei toota!
            Pohjus: ${{ steps.check.outputs.athliit_reason }}
            Kontrolli: https://athliit.ee
