name: Weekly Summary

on:
  schedule:
    - cron: "0 6 * * 1"  # Esmaspaev kell 6:00 UTC (8:00 Eesti aeg)
  workflow_dispatch:

env:
  TECH_EMAIL: "ruusmann@gmail.com"
  GITHUB_REPO: "Anne-dot/upptime-monitor"

jobs:
  summary:
    runs-on: ubuntu-latest
    steps:
      - name: Kogu nadalastatistika
        id: stats
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== IGANADALANE ULEVAADE ===" > summary.txt
          echo "Kuupaev: $(date '+%Y-%m-%d %H:%M') UTC" >> summary.txt
          echo "" >> summary.txt
          
          # ============================================
          # LEGEND
          # ============================================
          echo "LEGEND: Kiirus üü¢<1s üü°1-3s üî¥>3s | SSL ‚úÖ>30p ‚ö†Ô∏è14-30p üî¥<14p" >> summary.txt
          echo "" >> summary.txt
          
          # ============================================
          # 1. VEEBILEHTEDE STAATUS
          # ============================================
          echo "## VEEBILEHTEDE STAATUS" >> summary.txt
          echo "" >> summary.txt
          
          all_ok=true
          ssl_warnings=""
          slow_sites=""
          
          check_site() {
            local name=$1
            local url=$2
            local check_ssl=$3
            
            # Moot vastamise aega
            start_time=$(date +%s%N)
            status=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 30 "$url" 2>/dev/null)
            end_time=$(date +%s%N)
            
            duration_ms=$(( (end_time - start_time) / 1000000 ))
            
            if [ "$status" = "200" ]; then
              if [ $duration_ms -lt 1000 ]; then
                speed_icon="üü¢"
              elif [ $duration_ms -lt 3000 ]; then
                speed_icon="üü°"
              else
                speed_icon="üî¥"
                slow_sites="$slow_sites\n- $name: ${duration_ms}ms"
                all_ok=false
              fi
              https_result="$speed_icon ${duration_ms}ms"
            else
              https_result="‚ùå HTTP $status"
              all_ok=false
            fi
            
            # SSL kontroll
            ssl_result="-"
            if [ "$check_ssl" = "true" ]; then
              host=$(echo "$url" | sed 's|https://||' | sed 's|/.*||')
              ssl_info=$(echo | openssl s_client -connect "$host:443" -servername "$host" 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
              if [ -n "$ssl_info" ]; then
                expiry_epoch=$(date -d "$ssl_info" +%s 2>/dev/null)
                now_epoch=$(date +%s)
                if [ -n "$expiry_epoch" ]; then
                  days_left=$(( (expiry_epoch - now_epoch) / 86400 ))
                  if [ $days_left -gt 30 ]; then
                    ssl_result="‚úÖ ${days_left}p"
                  elif [ $days_left -gt 14 ]; then
                    ssl_result="‚ö†Ô∏è ${days_left}p"
                    ssl_warnings="$ssl_warnings\n- $name: $days_left paeva"
                  else
                    ssl_result="üî¥ ${days_left}p"
                    ssl_warnings="$ssl_warnings\n- $name: $days_left paeva"
                    all_ok=false
                  fi
                fi
              else
                ssl_result="‚ùå"
                all_ok=false
              fi
            fi
            
            printf "%-20s | %-15s | %s\n" "$name" "$https_result" "$ssl_result" >> summary.txt
          }
          
          printf "%-20s | %-15s | %s\n" "Veebileht" "Kiirus" "SSL" >> summary.txt
          printf "%-20s | %-15s | %s\n" "--------------------" "---------------" "--------" >> summary.txt
          
          check_site "nirgu.ee" "https://nirgu.ee" "true"
          check_site "birdbusters.eu" "https://birdbusters.eu" "true"
          check_site "sharpy.ee" "https://sharpy.ee" "true"
          check_site "linnupeletaja.ee" "http://linnupeletaja.ee" "false"
          check_site "lasteaiapildid.ee" "https://lasteaiapildid.ee" "true"
          check_site "athliit.ee" "https://athliit.ee" "true"
          
          echo "" >> summary.txt
          
          # ============================================
          # 2. HOIATUSED (ainult kui on)
          # ============================================
          if [ -n "$ssl_warnings" ]; then
            echo "## ‚ö†Ô∏è SSL AEGUB VARSTI" >> summary.txt
            echo -e "$ssl_warnings" >> summary.txt
            echo "" >> summary.txt
          fi
          
          if [ -n "$slow_sites" ]; then
            echo "## üêå AEGLASED LEHED" >> summary.txt
            echo -e "$slow_sites" >> summary.txt
            echo "" >> summary.txt
          fi
          
          # ============================================
          # 3. REPO STAATUS
          # ============================================
          echo "## REPO STAATUS" >> summary.txt
          echo "" >> summary.txt
          
          visibility=$(gh api "repos/$GITHUB_REPO" --jq '.visibility' 2>/dev/null || echo "unknown")
          
          if [ "$visibility" = "private" ]; then
            echo "‚ö†Ô∏è PRIVATE - j√§lgi minuteid: github.com/settings/billing" >> summary.txt
          else
            echo "‚úÖ PUBLIC - piiramatu Actions" >> summary.txt
          fi
          
          echo "" >> summary.txt
          
          # ============================================
          # 4. KOKKUVOTE
          # ============================================
          echo "---" >> summary.txt
          if [ "$all_ok" = true ]; then
            echo "‚úÖ KOIK KORRAS!" >> summary.txt
            echo "status=ok" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è VAJAVAD TAHELEPANU - vaata ulevalpool" >> summary.txt
            echo "status=issues" >> $GITHUB_OUTPUT
          fi
          
          echo "" >> summary.txt
          echo "Monitor: https://github.com/$GITHUB_REPO" >> summary.txt
          
          cat summary.txt
          
          echo 'SUMMARY<<EOF' >> $GITHUB_OUTPUT
          cat summary.txt >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Saada kokkuvote meil
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "${{ steps.stats.outputs.status == 'ok' && '‚úÖ' || '‚ö†Ô∏è' }} Iganadalane ulevaade - Veebilehed"
          to: ${{ env.TECH_EMAIL }}
          from: Veebilehtede seire
          body: ${{ steps.stats.outputs.SUMMARY }}
