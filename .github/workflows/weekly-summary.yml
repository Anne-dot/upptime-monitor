name: Weekly Summary

on:
  schedule:
    - cron: "0 6 * * 1"  # EsmaspÃ¤ev kell 6:00 UTC (8:00 Eesti aeg)
  workflow_dispatch:

env:
  TECH_EMAIL: "ruusmann@gmail.com"
  GITHUB_REPO: "Anne-dot/upptime-monitor"

jobs:
  summary:
    runs-on: ubuntu-latest
    steps:
      - name: Kogu nÃ¤dalastatistika
        id: stats
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== IGANÃ„DALANE ÃœLEVAADE ===" > summary.txt
          echo "KuupÃ¤ev: $(TZ='Europe/Tallinn' date '+%Y-%m-%d %H:%M') Eesti aeg" >> summary.txt
          echo "" >> summary.txt
          
          # ============================================
          # LEGEND
          # ============================================
          echo "LEGEND:" >> summary.txt
          echo "" >> summary.txt
          echo "Kiirus   ðŸš€ < 0,5s   ðŸŸ¢ 0,5 - 1s   ðŸŸ¡ 1 - 3s     ðŸ”´ > 3s" >> summary.txt
          echo "SSL                  ðŸŸ¢ > 30p      ðŸŸ¡ 14 - 30p   ðŸ”´ < 14p" >> summary.txt
          echo "" >> summary.txt
          
          # ============================================
          # 1. VEEBILEHTEDE STAATUS (hetke seis)
          # ============================================
          echo "## HETKE STAATUS" >> summary.txt
          echo "" >> summary.txt
          
          all_ok=true
          ssl_warnings=""
          slow_sites=""
          
          check_site() {
            local name=$1
            local url=$2
            local check_ssl=$3
            
            start_time=$(date +%s%N)
            status=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 30 "$url" 2>/dev/null)
            end_time=$(date +%s%N)
            
            duration_ms=$(( (end_time - start_time) / 1000000 ))
            duration_sec=$(echo "scale=1; $duration_ms / 1000" | bc | sed 's/\./,/')
            
            if [ "$status" = "200" ]; then
              if [ $duration_ms -lt 500 ]; then
                speed_icon="ðŸš€"
              elif [ $duration_ms -lt 1000 ]; then
                speed_icon="ðŸŸ¢"
              elif [ $duration_ms -lt 3000 ]; then
                speed_icon="ðŸŸ¡"
              else
                speed_icon="ðŸ”´"
                slow_sites="$slow_sites\n- $name: ${duration_sec}s"
                all_ok=false
              fi
              https_result="$speed_icon ${duration_sec}s"
            else
              https_result="âŒ HTTP $status"
              all_ok=false
            fi
            
            ssl_result="-"
            if [ "$check_ssl" = "true" ]; then
              host=$(echo "$url" | sed 's|https://||' | sed 's|/.*||')
              ssl_info=$(echo | openssl s_client -connect "$host:443" -servername "$host" 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
              if [ -n "$ssl_info" ]; then
                expiry_epoch=$(date -d "$ssl_info" +%s 2>/dev/null)
                now_epoch=$(date +%s)
                if [ -n "$expiry_epoch" ]; then
                  days_left=$(( (expiry_epoch - now_epoch) / 86400 ))
                  if [ $days_left -gt 30 ]; then
                    ssl_result="ðŸŸ¢ ${days_left}p"
                  elif [ $days_left -gt 14 ]; then
                    ssl_result="ðŸŸ¡ ${days_left}p"
                    ssl_warnings="$ssl_warnings\n- $name: $days_left pÃ¤eva"
                  else
                    ssl_result="ðŸ”´ ${days_left}p"
                    ssl_warnings="$ssl_warnings\n- $name: $days_left pÃ¤eva"
                    all_ok=false
                  fi
                fi
              else
                ssl_result="âŒ"
                all_ok=false
              fi
            fi
            
            printf "%-20s | %-12s | %s\n" "$name" "$https_result" "$ssl_result" >> summary.txt
          }
          
          printf "%-20s | %-12s | %s\n" "Veebileht" "Kiirus (s)" "SSL" >> summary.txt
          printf "%-20s | %-12s | %s\n" "--------------------" "------------" "--------" >> summary.txt
          
          check_site "nirgu.ee" "https://nirgu.ee" "true"
          check_site "birdbusters.eu" "https://birdbusters.eu" "true"
          check_site "sharpy.ee" "https://sharpy.ee" "true"
          check_site "linnupeletaja.ee" "http://linnupeletaja.ee" "false"
          check_site "lasteaiapildid.ee" "https://lasteaiapildid.ee" "true"
          check_site "athliit.ee" "https://athliit.ee" "true"
          
          echo "" >> summary.txt
          
          # ============================================
          # 2. NÃ„DALA VEAD (koos pÃµhjustega)
          # ============================================
          echo "## NÃ„DALA VEAD" >> summary.txt
          echo "" >> summary.txt
          
          week_ago=$(date -d '7 days ago' -Iseconds)
          
          # Kogu vead failist
          rm -f /tmp/errors_detailed.txt
          touch /tmp/errors_detailed.txt
          
          # Saa failed runid
          failed_run_ids=$(gh api "repos/$GITHUB_REPO/actions/runs?status=failure&created=>$week_ago&per_page=100" --jq '.workflow_runs[].id' 2>/dev/null)
          
          for run_id in $failed_run_ids; do
            # Saa run info (aeg)
            run_time=$(gh api "repos/$GITHUB_REPO/actions/runs/$run_id" --jq '.created_at[0:10]' 2>/dev/null)
            
            # Saa failed jobid ja nende annotations
            failed_jobs=$(gh api "repos/$GITHUB_REPO/actions/runs/$run_id/jobs" --jq '.jobs[] | select(.conclusion == "failure") | {id: .id, name: .name}' 2>/dev/null)
            
            echo "$failed_jobs" | jq -c '.' 2>/dev/null | while read job_info; do
              job_id=$(echo "$job_info" | jq -r '.id')
              job_name=$(echo "$job_info" | jq -r '.name')
              
              # MÃ¤Ã¤ra sait nime jÃ¤rgi
              site=""
              case "$job_name" in
                *nirgu*) site="nirgu.ee" ;;
                *birdbusters*) site="birdbusters.eu" ;;
                *sharpy*) site="sharpy.ee" ;;
                *linnupeletaja*) site="linnupeletaja.ee" ;;
                *lasteaiapildid*) site="lasteaiapildid.ee" ;;
                *athliit*) site="athliit.ee" ;;
                *) site="monitoring" ;;
              esac
              
              # Proovi saada vea pÃµhjus annotatsioonidest
              annotation=$(gh api "repos/$GITHUB_REPO/check-runs/$job_id/annotations" --jq '.[0].message' 2>/dev/null | head -c 50)
              
              if [ -z "$annotation" ] || [ "$annotation" = "null" ]; then
                # Kui annotation puudub, kasuta Ã¼ldist pÃµhjust
                if echo "$annotation" | grep -qi "billing\|payment\|spending"; then
                  reason="billing limit"
                elif echo "$job_name" | grep -qi "ssl"; then
                  reason="SSL kontroll"
                else
                  reason="HTTP kontroll"
                fi
              else
                # LÃ¼henda annotation
                reason=$(echo "$annotation" | cut -c1-40)
              fi
              
              echo "$site|$run_time|$reason" >> /tmp/errors_detailed.txt
            done
          done
          
          # Kui vigu on
          if [ -s /tmp/errors_detailed.txt ]; then
            # Grupeeri saidi kaupa
            for site in "nirgu.ee" "birdbusters.eu" "sharpy.ee" "linnupeletaja.ee" "lasteaiapildid.ee" "athliit.ee"; do
              site_errors=$(grep "^$site|" /tmp/errors_detailed.txt 2>/dev/null)
              error_count=$(echo "$site_errors" | grep -c "." 2>/dev/null || echo "0")
              
              if [ "$error_count" -gt 0 ] && [ -n "$site_errors" ]; then
                echo "$site ($error_count viga):" >> summary.txt
                echo "$site_errors" | head -3 | while IFS='|' read s date reason; do
                  echo "  - $date: $reason" >> summary.txt
                done
                if [ "$error_count" -gt 3 ]; then
                  echo "  - ... ja veel $((error_count - 3))" >> summary.txt
                fi
                echo "" >> summary.txt
              fi
            done
            
            # Monitoring vead eraldi
            monitoring_errors=$(grep "^monitoring|" /tmp/errors_detailed.txt 2>/dev/null | wc -l)
            if [ "$monitoring_errors" -gt 0 ]; then
              echo "Monitoring vead: $monitoring_errors (billing/sÃ¼steem)" >> summary.txt
              echo "" >> summary.txt
            fi
          else
            echo "âœ… Vigu polnud!" >> summary.txt
            echo "" >> summary.txt
          fi
          
          # ============================================
          # 3. HOIATUSED (ainult kui on)
          # ============================================
          if [ -n "$ssl_warnings" ]; then
            echo "## âš ï¸ SSL AEGUB VARSTI" >> summary.txt
            echo -e "$ssl_warnings" >> summary.txt
            echo "" >> summary.txt
          fi
          
          if [ -n "$slow_sites" ]; then
            echo "## ðŸŒ AEGLASED LEHED" >> summary.txt
            echo -e "$slow_sites" >> summary.txt
            echo "" >> summary.txt
          fi
          
          # ============================================
          # 4. REPO STAATUS
          # ============================================
          echo "## REPO" >> summary.txt
          visibility=$(gh api "repos/$GITHUB_REPO" --jq '.visibility' 2>/dev/null || echo "unknown")
          if [ "$visibility" = "private" ]; then
            echo "âš ï¸ PRIVATE - jÃ¤lgi minuteid" >> summary.txt
          else
            echo "âœ… PUBLIC" >> summary.txt
          fi
          echo "" >> summary.txt
          
          # ============================================
          # 5. KOKKUVÃ•TE
          # ============================================
          echo "---" >> summary.txt
          total_errors=$(wc -l < /tmp/errors_detailed.txt 2>/dev/null || echo "0")
          if [ "$all_ok" = true ] && [ "$total_errors" -eq 0 ]; then
            echo "âœ… KÃ•IK KORRAS!" >> summary.txt
            echo "status=ok" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ VAATA ÃœLEVALPOOL" >> summary.txt
            echo "status=issues" >> $GITHUB_OUTPUT
          fi
          
          echo "" >> summary.txt
          echo "https://github.com/$GITHUB_REPO" >> summary.txt
          
          cat summary.txt
          
          echo 'SUMMARY<<EOF' >> $GITHUB_OUTPUT
          cat summary.txt >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Saada kokkuvÃµte meil
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ðŸ“Š Veebilehed mÃ¶Ã¶dunud nÃ¤dalal"
          to: ${{ env.TECH_EMAIL }}
          from: Veebilehtede seire
          body: ${{ steps.stats.outputs.SUMMARY }}
