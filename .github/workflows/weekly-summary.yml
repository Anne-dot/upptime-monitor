name: Weekly Summary

on:
  schedule:
    - cron: "0 6 * * 1"  # Esmasp√§ev kell 6:00 UTC (8:00 Eesti aeg)
  workflow_dispatch:

env:
  TECH_EMAIL: "ruusmann@gmail.com"
  GITHUB_REPO: "Anne-dot/upptime-monitor"

jobs:
  summary:
    runs-on: ubuntu-latest
    steps:
      # ============================================
      # CHECKOUT - sites.json jaoks
      # ============================================
      - name: Checkout
        uses: actions/checkout@v4

      - name: Kogu n√§dalastatistika
        id: stats
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e

          # ============================================
          # SITES.JSON - Single Source of Truth
          # ============================================
          SITES_FILE="sites.json"
          SITE_COUNT=$(jq length "$SITES_FILE")

          # Temp failid (bash subshell workaround)
          > /tmp/slow_sites.txt
          > /tmp/ssl_warnings.txt
          > /tmp/errors.txt

          # ============================================
          # HTML ALGUS
          # ============================================
          cat > summary.html << 'HTMLHEAD'
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #333; max-width: 600px; }
              h1 { font-size: 18px; border-bottom: 2px solid #eee; padding-bottom: 8px; }
              h2 { font-size: 14px; color: #666; margin-top: 24px; }
              table { border-collapse: collapse; width: 100%; margin: 12px 0; }
              th, td { text-align: left; padding: 8px 12px; border: 1px solid #ddd; }
              th { background: #f5f5f5; font-weight: 600; }
              .legend { font-size: 12px; color: #888; margin: 16px 0; }
              .footer { margin-top: 24px; padding-top: 16px; border-top: 1px solid #eee; font-size: 12px; color: #888; }
              .ok { color: #22863a; }
              .warn { color: #b08800; }
              .site-block { margin: 12px 0; }
              .site-name { font-weight: 600; }
              .error-item { margin-left: 16px; color: #666; font-size: 13px; }
            </style>
          </head>
          <body>
          HTMLHEAD

          echo "<h1>üìä Igan√§dalane √ºlevaade</h1>" >> summary.html
          echo "<p style='color:#888;font-size:13px;'>$(TZ='Europe/Tallinn' date '+%Y-%m-%d %H:%M %Z')</p>" >> summary.html
          echo "<div class='legend'><strong>Kiirus:</strong> üöÄ &lt;0,5s üü¢ 0,5-1s üü° 1-3s üî¥ &gt;3s &nbsp; <strong>SSL:</strong> üü¢ &gt;30p üü° 14-30p üî¥ &lt;14p</div>" >> summary.html

          # ============================================
          # 1. STAATUS - loop sites.json
          # ============================================
          echo "<h2>Hetke staatus</h2>" >> summary.html
          echo "<table><tr><th>Veebileht</th><th>Kiirus (s)</th><th>SSL</th></tr>" >> summary.html

          all_ok="true"

          for i in $(seq 0 $((SITE_COUNT - 1))); do
            name=$(jq -r ".[$i].name" "$SITES_FILE")
            url=$(jq -r ".[$i].url" "$SITES_FILE")
            check_ssl=$(jq -r ".[$i].ssl" "$SITES_FILE")

            # M√µ√µda kiirus
            start_ns=$(date +%s%N)
            http_code=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 30 "$url" 2>/dev/null || echo "000")
            end_ns=$(date +%s%N)
            ms=$(( (end_ns - start_ns) / 1000000 ))
            sec=$(printf "%.1f" "$(echo "scale=1; $ms / 1000" | bc)" | sed 's/\./,/')

            # Kiiruse ikoon
            if [ "$http_code" = "200" ]; then
              if [ $ms -lt 500 ]; then speed="üöÄ $sec"
              elif [ $ms -lt 1000 ]; then speed="üü¢ $sec"
              elif [ $ms -lt 3000 ]; then speed="üü° $sec"
              else
                speed="üî¥ $sec"
                echo "<li>$name: $sec</li>" >> /tmp/slow_sites.txt
                all_ok="false"
              fi
            else
              speed="‚ùå HTTP $http_code"
              all_ok="false"
            fi

            # SSL
            ssl="-"
            if [ "$check_ssl" = "true" ]; then
              host=$(echo "$url" | sed 's|https://||' | sed 's|/.*||')
              expiry=$(echo | openssl s_client -connect "$host:443" -servername "$host" 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
              if [ -n "$expiry" ]; then
                exp_epoch=$(date -d "$expiry" +%s 2>/dev/null || echo "0")
                now_epoch=$(date +%s)
                days=$(( (exp_epoch - now_epoch) / 86400 ))
                if [ $days -gt 30 ]; then ssl="üü¢ ${days}p"
                elif [ $days -gt 14 ]; then
                  ssl="üü° ${days}p"
                  echo "<li>$name: $days p√§eva</li>" >> /tmp/ssl_warnings.txt
                else
                  ssl="üî¥ ${days}p"
                  echo "<li>$name: $days p√§eva</li>" >> /tmp/ssl_warnings.txt
                  all_ok="false"
                fi
              else
                ssl="‚ùå"
                all_ok="false"
              fi
            fi

            echo "<tr><td>$name</td><td>$speed</td><td>$ssl</td></tr>" >> summary.html
          done

          echo "</table>" >> summary.html

          # ============================================
          # 2. N√ÑDALA PROBLEEMID
          # ============================================
          week_ago=$(date -d '7 days ago' -Iseconds)
          failed_runs=$(gh api "repos/$GITHUB_REPO/actions/runs?status=failure&created=>$week_ago&per_page=100" --jq '.workflow_runs[].id' 2>/dev/null || echo "")

          for run_id in $failed_runs; do
            run_date=$(gh api "repos/$GITHUB_REPO/actions/runs/$run_id" --jq '.created_at[5:10]' 2>/dev/null | sed 's/-/./')
            failed_jobs=$(gh api "repos/$GITHUB_REPO/actions/runs/$run_id/jobs" --jq '.jobs[] | select(.conclusion == "failure") | .name' 2>/dev/null || echo "")

            while IFS= read -r job_name; do
              [ -z "$job_name" ] && continue

              # Leia sait sites.json p√µhjal
              site="system"
              for j in $(seq 0 $((SITE_COUNT - 1))); do
                site_name=$(jq -r ".[$j].name" "$SITES_FILE")
                site_key="${site_name%%.*}"
                if echo "$job_name" | grep -qi "$site_key"; then
                  site="$site_name"
                  break
                fi
              done

              # P√µhjus
              reason="HTTP kontroll"
              echo "$job_name" | grep -qi "ssl" && reason="SSL kontroll"

              echo "$site|$reason|$run_date" >> /tmp/errors.txt
            done <<< "$failed_jobs"
          done

          # N√§ita probleeme
          total_errors=$(grep -cv "^system|" /tmp/errors.txt 2>/dev/null || echo "0")

          if [ "$total_errors" -gt 0 ]; then
            echo "<h2>‚ö†Ô∏è Probleemid n√§dalal</h2>" >> summary.html

            for i in $(seq 0 $((SITE_COUNT - 1))); do
              site_name=$(jq -r ".[$i].name" "$SITES_FILE")
              site_errors=$(grep "^$site_name|" /tmp/errors.txt 2>/dev/null || true)
              [ -z "$site_errors" ] && continue

              echo "<div class='site-block'><div class='site-name'>$site_name</div>" >> summary.html
              echo "$site_errors" | cut -d'|' -f2 | sort | uniq -c | sort -rn | head -3 | while read count reason; do
                last_date=$(echo "$site_errors" | grep "|$reason|" | cut -d'|' -f3 | sort -r | head -1)
                echo "<div class='error-item'>‚Ä¢ $reason - viimati $last_date (${count}x)</div>" >> summary.html
              done
              echo "</div>" >> summary.html
            done
          else
            echo "<h2>N√§dala vead</h2><p class='ok'>‚úÖ Vigu polnud!</p>" >> summary.html
          fi

          # S√ºsteemivead
          sys_errors=$(grep -c "^system|" /tmp/errors.txt 2>/dev/null || echo "0")
          [ "$sys_errors" -gt 0 ] && echo "<p style='color:#888;font-size:12px;'>‚ÑπÔ∏è + $sys_errors s√ºsteemiviga</p>" >> summary.html

          # ============================================
          # 3. HOIATUSED
          # ============================================
          [ -s /tmp/ssl_warnings.txt ] && echo "<h2>‚ö†Ô∏è SSL aegub varsti</h2><ul>$(cat /tmp/ssl_warnings.txt)</ul>" >> summary.html
          [ -s /tmp/slow_sites.txt ] && echo "<h2>üêå Aeglased lehed</h2><ul>$(cat /tmp/slow_sites.txt)</ul>" >> summary.html

          # ============================================
          # FOOTER
          # ============================================
          echo "<div class='footer'>" >> summary.html
          if [ "$all_ok" = "true" ] && [ "$total_errors" -eq 0 ]; then
            echo "<strong class='ok'>‚úÖ K√µik korras!</strong><br>" >> summary.html
            echo "status=ok" >> $GITHUB_OUTPUT
          else
            echo "<strong class='warn'>‚ö†Ô∏è Vaata √ºlevalpool</strong><br>" >> summary.html
            echo "status=issues" >> $GITHUB_OUTPUT
          fi
          echo "<a href='https://github.com/$GITHUB_REPO'>github.com/$GITHUB_REPO</a></div></body></html>" >> summary.html

          cat summary.html
          echo 'SUMMARY<<EOF' >> $GITHUB_OUTPUT
          cat summary.html >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Saada kokkuv√µte meil
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üìä Veebilehed m√∂√∂dunud n√§dalal"
          to: ${{ env.TECH_EMAIL }}
          from: Veebilehtede seire
          html_body: ${{ steps.stats.outputs.SUMMARY }}
