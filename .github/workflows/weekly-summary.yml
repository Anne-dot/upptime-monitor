name: Weekly Summary

on:
  schedule:
    - cron: "0 6 * * 1"  # Esmaspaev kell 6:00 UTC (8:00 Eesti aeg)
  workflow_dispatch:

env:
  TECH_EMAIL: "ruusmann@gmail.com"
  GITHUB_REPO: "Anne-dot/upptime-monitor"

jobs:
  summary:
    runs-on: ubuntu-latest
    steps:
      - name: Kogu nadalastatistika
        id: stats
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== IGANADALANE ULEVAADE ===" > summary.txt
          echo "Kuupaev: $(date '+%Y-%m-%d %H:%M') UTC" >> summary.txt
          echo "" >> summary.txt
          
          # ============================================
          # LEGEND
          # ============================================
          echo "LEGEND: Kiirus üü¢<1s üü°1-3s üî¥>3s | SSL ‚úÖ>30p ‚ö†Ô∏è14-30p üî¥<14p" >> summary.txt
          echo "" >> summary.txt
          
          # ============================================
          # 1. VEEBILEHTEDE STAATUS (hetke seis)
          # ============================================
          echo "## HETKE STAATUS" >> summary.txt
          echo "" >> summary.txt
          
          all_ok=true
          ssl_warnings=""
          slow_sites=""
          
          check_site() {
            local name=$1
            local url=$2
            local check_ssl=$3
            
            start_time=$(date +%s%N)
            status=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 30 "$url" 2>/dev/null)
            end_time=$(date +%s%N)
            
            duration_ms=$(( (end_time - start_time) / 1000000 ))
            
            if [ "$status" = "200" ]; then
              if [ $duration_ms -lt 1000 ]; then
                speed_icon="üü¢"
              elif [ $duration_ms -lt 3000 ]; then
                speed_icon="üü°"
              else
                speed_icon="üî¥"
                slow_sites="$slow_sites\n- $name: ${duration_ms}ms"
                all_ok=false
              fi
              https_result="$speed_icon ${duration_ms}ms"
            else
              https_result="‚ùå HTTP $status"
              all_ok=false
            fi
            
            ssl_result="-"
            if [ "$check_ssl" = "true" ]; then
              host=$(echo "$url" | sed 's|https://||' | sed 's|/.*||')
              ssl_info=$(echo | openssl s_client -connect "$host:443" -servername "$host" 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
              if [ -n "$ssl_info" ]; then
                expiry_epoch=$(date -d "$ssl_info" +%s 2>/dev/null)
                now_epoch=$(date +%s)
                if [ -n "$expiry_epoch" ]; then
                  days_left=$(( (expiry_epoch - now_epoch) / 86400 ))
                  if [ $days_left -gt 30 ]; then
                    ssl_result="‚úÖ ${days_left}p"
                  elif [ $days_left -gt 14 ]; then
                    ssl_result="‚ö†Ô∏è ${days_left}p"
                    ssl_warnings="$ssl_warnings\n- $name: $days_left paeva"
                  else
                    ssl_result="üî¥ ${days_left}p"
                    ssl_warnings="$ssl_warnings\n- $name: $days_left paeva"
                    all_ok=false
                  fi
                fi
              else
                ssl_result="‚ùå"
                all_ok=false
              fi
            fi
            
            printf "%-20s | %-15s | %s\n" "$name" "$https_result" "$ssl_result" >> summary.txt
          }
          
          printf "%-20s | %-15s | %s\n" "Veebileht" "Kiirus" "SSL" >> summary.txt
          printf "%-20s | %-15s | %s\n" "--------------------" "---------------" "--------" >> summary.txt
          
          check_site "nirgu.ee" "https://nirgu.ee" "true"
          check_site "birdbusters.eu" "https://birdbusters.eu" "true"
          check_site "sharpy.ee" "https://sharpy.ee" "true"
          check_site "linnupeletaja.ee" "http://linnupeletaja.ee" "false"
          check_site "lasteaiapildid.ee" "https://lasteaiapildid.ee" "true"
          check_site "athliit.ee" "https://athliit.ee" "true"
          
          echo "" >> summary.txt
          
          # ============================================
          # 2. NADALA VEAD (iga veebilehe kohta)
          # ============================================
          echo "## NADALA VEAD" >> summary.txt
          echo "" >> summary.txt
          
          # Kogu viimase 7 paeva failed job'id
          week_ago=$(date -d '7 days ago' -Iseconds)
          
          # Saa koik failed runid
          failed_run_ids=$(gh api "repos/$GITHUB_REPO/actions/runs?status=failure&created=>$week_ago&per_page=100" --jq '.workflow_runs[].id' 2>/dev/null)
          
          # Loenda vead veebilehtede kaupa
          declare -A site_errors
          site_errors[nirgu]=0
          site_errors[birdbusters]=0
          site_errors[sharpy]=0
          site_errors[linnupeletaja]=0
          site_errors[lasteaiapildid]=0
          site_errors[athliit]=0
          
          for run_id in $failed_run_ids; do
            # Saa failed jobid sellest runist
            failed_jobs=$(gh api "repos/$GITHUB_REPO/actions/runs/$run_id/jobs" --jq '.jobs[] | select(.conclusion == "failure") | .name' 2>/dev/null)
            
            # Loenda iga saidi vead
            echo "$failed_jobs" | while read job_name; do
              case "$job_name" in
                *nirgu*) echo "nirgu" >> /tmp/errors.txt ;;
                *birdbusters*) echo "birdbusters" >> /tmp/errors.txt ;;
                *sharpy*) echo "sharpy" >> /tmp/errors.txt ;;
                *linnupeletaja*) echo "linnupeletaja" >> /tmp/errors.txt ;;
                *lasteaiapildid*) echo "lasteaiapildid" >> /tmp/errors.txt ;;
                *athliit*) echo "athliit" >> /tmp/errors.txt ;;
              esac
            done
          done
          
          # Loe kokku
          touch /tmp/errors.txt
          nirgu_err=$(grep -c "nirgu" /tmp/errors.txt 2>/dev/null || echo "0")
          birdbusters_err=$(grep -c "birdbusters" /tmp/errors.txt 2>/dev/null || echo "0")
          sharpy_err=$(grep -c "sharpy" /tmp/errors.txt 2>/dev/null || echo "0")
          linnupeletaja_err=$(grep -c "linnupeletaja" /tmp/errors.txt 2>/dev/null || echo "0")
          lasteaiapildid_err=$(grep -c "lasteaiapildid" /tmp/errors.txt 2>/dev/null || echo "0")
          athliit_err=$(grep -c "athliit" /tmp/errors.txt 2>/dev/null || echo "0")
          
          total_errors=$((nirgu_err + birdbusters_err + sharpy_err + linnupeletaja_err + lasteaiapildid_err + athliit_err))
          
          printf "%-20s | %s\n" "Veebileht" "Vead" >> summary.txt
          printf "%-20s | %s\n" "--------------------" "-----" >> summary.txt
          
          print_errors() {
            local name=$1
            local count=$2
            if [ "$count" -gt 0 ]; then
              printf "%-20s | ‚ö†Ô∏è %s\n" "$name" "$count" >> summary.txt
            else
              printf "%-20s | ‚úÖ 0\n" "$name" >> summary.txt
            fi
          }
          
          print_errors "nirgu.ee" "$nirgu_err"
          print_errors "birdbusters.eu" "$birdbusters_err"
          print_errors "sharpy.ee" "$sharpy_err"
          print_errors "linnupeletaja.ee" "$linnupeletaja_err"
          print_errors "lasteaiapildid.ee" "$lasteaiapildid_err"
          print_errors "athliit.ee" "$athliit_err"
          
          echo "" >> summary.txt
          echo "Kokku: $total_errors viga viimase 7 paeva jooksul" >> summary.txt
          echo "" >> summary.txt
          
          # ============================================
          # 3. HOIATUSED (ainult kui on)
          # ============================================
          if [ -n "$ssl_warnings" ]; then
            echo "## ‚ö†Ô∏è SSL AEGUB VARSTI" >> summary.txt
            echo -e "$ssl_warnings" >> summary.txt
            echo "" >> summary.txt
          fi
          
          if [ -n "$slow_sites" ]; then
            echo "## üêå AEGLASED LEHED" >> summary.txt
            echo -e "$slow_sites" >> summary.txt
            echo "" >> summary.txt
          fi
          
          # ============================================
          # 4. REPO STAATUS
          # ============================================
          echo "## REPO" >> summary.txt
          visibility=$(gh api "repos/$GITHUB_REPO" --jq '.visibility' 2>/dev/null || echo "unknown")
          if [ "$visibility" = "private" ]; then
            echo "‚ö†Ô∏è PRIVATE - jalgi minuteid" >> summary.txt
          else
            echo "‚úÖ PUBLIC" >> summary.txt
          fi
          echo "" >> summary.txt
          
          # ============================================
          # 5. KOKKUVOTE
          # ============================================
          echo "---" >> summary.txt
          if [ "$all_ok" = true ] && [ "$total_errors" -eq 0 ]; then
            echo "‚úÖ KOIK KORRAS!" >> summary.txt
            echo "status=ok" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è VAATA ULEVALPOOL" >> summary.txt
            echo "status=issues" >> $GITHUB_OUTPUT
          fi
          
          echo "" >> summary.txt
          echo "https://github.com/$GITHUB_REPO" >> summary.txt
          
          cat summary.txt
          
          echo 'SUMMARY<<EOF' >> $GITHUB_OUTPUT
          cat summary.txt >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Saada kokkuvote meil
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "${{ steps.stats.outputs.status == 'ok' && '‚úÖ' || '‚ö†Ô∏è' }} Iganadalane ulevaade - Veebilehed"
          to: ${{ env.TECH_EMAIL }}
          from: Veebilehtede seire
          body: ${{ steps.stats.outputs.SUMMARY }}
