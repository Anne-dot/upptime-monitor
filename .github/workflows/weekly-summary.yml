name: Weekly Summary

on:
  schedule:
    - cron: "0 6 * * 1"  # Esmasp√§ev kell 6:00 UTC (8:00 Eesti aeg)
  workflow_dispatch:

env:
  TECH_EMAIL: "ruusmann@gmail.com"
  GITHUB_REPO: "Anne-dot/upptime-monitor"

jobs:
  summary:
    runs-on: ubuntu-latest
    steps:
      - name: Kogu n√§dalastatistika
        id: stats
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # HTML algus
          cat > summary.html << 'HTMLHEAD'
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #333; max-width: 600px; }
              h1 { font-size: 18px; color: #1a1a1a; border-bottom: 2px solid #eee; padding-bottom: 8px; }
              h2 { font-size: 14px; color: #666; margin-top: 24px; }
              table { border-collapse: collapse; width: 100%; margin: 12px 0; }
              th { text-align: left; padding: 8px 12px; background: #f5f5f5; border: 1px solid #ddd; font-weight: 600; }
              td { padding: 8px 12px; border: 1px solid #ddd; }
              .legend { font-size: 12px; color: #888; margin: 16px 0; }
              .footer { margin-top: 24px; padding-top: 16px; border-top: 1px solid #eee; font-size: 12px; color: #888; }
              .ok { color: #22863a; }
              .warn { color: #b08800; }
              .error { color: #cb2431; }
            </style>
          </head>
          <body>
          HTMLHEAD
          
          echo "<h1>üìä Igan√§dalane √ºlevaade</h1>" >> summary.html
          echo "<p style='color:#888;font-size:13px;'>$(TZ='Europe/Tallinn' date '+%Y-%m-%d %H:%M %Z')</p>" >> summary.html
          
          # Legend
          echo "<div class='legend'>" >> summary.html
          echo "<strong>Kiirus:</strong> üöÄ &lt;0,5s &nbsp; üü¢ 0,5-1s &nbsp; üü° 1-3s &nbsp; üî¥ &gt;3s &nbsp;&nbsp;" >> summary.html
          echo "<strong>SSL:</strong> üü¢ &gt;30p &nbsp; üü° 14-30p &nbsp; üî¥ &lt;14p" >> summary.html
          echo "</div>" >> summary.html
          
          # ============================================
          # 1. VEEBILEHTEDE STAATUS
          # ============================================
          echo "<h2>Hetke staatus</h2>" >> summary.html
          echo "<table>" >> summary.html
          echo "<tr><th>Veebileht</th><th>Kiirus</th><th>SSL</th></tr>" >> summary.html
          
          all_ok=true
          ssl_warnings=""
          slow_sites=""
          
          check_site() {
            local name=$1
            local url=$2
            local check_ssl=$3
            
            start_time=$(date +%s%N)
            status=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 30 "$url" 2>/dev/null)
            end_time=$(date +%s%N)
            
            duration_ms=$(( (end_time - start_time) / 1000000 ))
            duration_sec=$(echo "scale=1; $duration_ms / 1000" | bc | sed 's/\./,/')
            
            if [ "$status" = "200" ]; then
              if [ $duration_ms -lt 500 ]; then
                speed_icon="üöÄ"
              elif [ $duration_ms -lt 1000 ]; then
                speed_icon="üü¢"
              elif [ $duration_ms -lt 3000 ]; then
                speed_icon="üü°"
              else
                speed_icon="üî¥"
                slow_sites="$slow_sites<li>$name: ${duration_sec}s</li>"
                all_ok=false
              fi
              speed_result="$speed_icon ${duration_sec}s"
            else
              speed_result="‚ùå HTTP $status"
              all_ok=false
            fi
            
            ssl_result="-"
            if [ "$check_ssl" = "true" ]; then
              host=$(echo "$url" | sed 's|https://||' | sed 's|/.*||')
              ssl_info=$(echo | openssl s_client -connect "$host:443" -servername "$host" 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
              if [ -n "$ssl_info" ]; then
                expiry_epoch=$(date -d "$ssl_info" +%s 2>/dev/null)
                now_epoch=$(date +%s)
                if [ -n "$expiry_epoch" ]; then
                  days_left=$(( (expiry_epoch - now_epoch) / 86400 ))
                  if [ $days_left -gt 30 ]; then
                    ssl_result="üü¢ ${days_left}p"
                  elif [ $days_left -gt 14 ]; then
                    ssl_result="üü° ${days_left}p"
                    ssl_warnings="$ssl_warnings<li>$name: $days_left p√§eva</li>"
                  else
                    ssl_result="üî¥ ${days_left}p"
                    ssl_warnings="$ssl_warnings<li>$name: $days_left p√§eva</li>"
                    all_ok=false
                  fi
                fi
              else
                ssl_result="‚ùå"
                all_ok=false
              fi
            fi
            
            echo "<tr><td>$name</td><td>$speed_result</td><td>$ssl_result</td></tr>" >> summary.html
          }
          
          check_site "nirgu.ee" "https://nirgu.ee" "true"
          check_site "birdbusters.eu" "https://birdbusters.eu" "true"
          check_site "sharpy.ee" "https://sharpy.ee" "true"
          check_site "linnupeletaja.ee" "http://linnupeletaja.ee" "false"
          check_site "lasteaiapildid.ee" "https://lasteaiapildid.ee" "true"
          check_site "athliit.ee" "https://athliit.ee" "true"
          
          echo "</table>" >> summary.html
          
          # ============================================
          # 2. N√ÑDALA VEAD
          # ============================================
          echo "<h2>N√§dala vead</h2>" >> summary.html
          
          week_ago=$(date -d '7 days ago' -Iseconds)
          rm -f /tmp/errors_detailed.txt
          touch /tmp/errors_detailed.txt
          
          failed_run_ids=$(gh api "repos/$GITHUB_REPO/actions/runs?status=failure&created=>$week_ago&per_page=100" --jq '.workflow_runs[].id' 2>/dev/null)
          
          for run_id in $failed_run_ids; do
            run_time=$(gh api "repos/$GITHUB_REPO/actions/runs/$run_id" --jq '.created_at[0:10]' 2>/dev/null)
            failed_jobs=$(gh api "repos/$GITHUB_REPO/actions/runs/$run_id/jobs" --jq '.jobs[] | select(.conclusion == "failure") | .name' 2>/dev/null)
            
            echo "$failed_jobs" | while read job_name; do
              site=""
              case "$job_name" in
                *nirgu*) site="nirgu.ee" ;;
                *birdbusters*) site="birdbusters.eu" ;;
                *sharpy*) site="sharpy.ee" ;;
                *linnupeletaja*) site="linnupeletaja.ee" ;;
                *lasteaiapildid*) site="lasteaiapildid.ee" ;;
                *athliit*) site="athliit.ee" ;;
                *) site="monitoring" ;;
              esac
              echo "$site|$run_time" >> /tmp/errors_detailed.txt
            done
          done
          
          if [ -s /tmp/errors_detailed.txt ]; then
            echo "<table>" >> summary.html
            echo "<tr><th>Veebileht</th><th>Vead</th></tr>" >> summary.html
            
            for site in "nirgu.ee" "birdbusters.eu" "sharpy.ee" "linnupeletaja.ee" "lasteaiapildid.ee" "athliit.ee"; do
              error_count=$(grep -c "^$site|" /tmp/errors_detailed.txt 2>/dev/null || echo "0")
              if [ "$error_count" -gt 0 ]; then
                echo "<tr><td>$site</td><td class='warn'>‚ö†Ô∏è $error_count</td></tr>" >> summary.html
              else
                echo "<tr><td>$site</td><td class='ok'>‚úÖ 0</td></tr>" >> summary.html
              fi
            done
            
            echo "</table>" >> summary.html
            
            monitoring_errors=$(grep -c "^monitoring|" /tmp/errors_detailed.txt 2>/dev/null || echo "0")
            if [ "$monitoring_errors" -gt 0 ]; then
              echo "<p style='color:#888;font-size:12px;'>+ $monitoring_errors monitoring viga (billing/s√ºsteem)</p>" >> summary.html
            fi
          else
            echo "<p class='ok'>‚úÖ Vigu polnud!</p>" >> summary.html
          fi
          
          # ============================================
          # 3. HOIATUSED
          # ============================================
          if [ -n "$ssl_warnings" ]; then
            echo "<h2>‚ö†Ô∏è SSL aegub varsti</h2>" >> summary.html
            echo "<ul>$ssl_warnings</ul>" >> summary.html
          fi
          
          if [ -n "$slow_sites" ]; then
            echo "<h2>üêå Aeglased lehed</h2>" >> summary.html
            echo "<ul>$slow_sites</ul>" >> summary.html
          fi
          
          # ============================================
          # Footer
          # ============================================
          total_errors=$(wc -l < /tmp/errors_detailed.txt 2>/dev/null || echo "0")
          echo "<div class='footer'>" >> summary.html
          if [ "$all_ok" = true ] && [ "$total_errors" -eq 0 ]; then
            echo "<strong class='ok'>‚úÖ K√µik korras!</strong><br>" >> summary.html
            echo "status=ok" >> $GITHUB_OUTPUT
          else
            echo "<strong class='warn'>‚ö†Ô∏è Vaata √ºlevalpool</strong><br>" >> summary.html
            echo "status=issues" >> $GITHUB_OUTPUT
          fi
          echo "<a href='https://github.com/$GITHUB_REPO'>github.com/$GITHUB_REPO</a>" >> summary.html
          echo "</div>" >> summary.html
          
          echo "</body></html>" >> summary.html
          
          cat summary.html
          
          # Save for email
          echo 'SUMMARY<<EOF' >> $GITHUB_OUTPUT
          cat summary.html >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Saada kokkuv√µte meil
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üìä Veebilehed m√∂√∂dunud n√§dalal"
          to: ${{ env.TECH_EMAIL }}
          from: Veebilehtede seire
          html_body: ${{ steps.stats.outputs.SUMMARY }}
