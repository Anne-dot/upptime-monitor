name: Uptime Check

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

# ============================================
# SEADISTUS
# ============================================
env:
  TEST_MODE: "false"
  TECH_EMAIL: "ruusmann@gmail.com"

jobs:
  # ============================================
  # HTTPS KONTROLL - kõik lehed ühes kohas
  # 
  # Kontrollib:
  # 1. Kas leht vastab (timeout 30 sek)
  # 2. Kas HTTP staatus on 200
  # 3. Kas lehel pole PHP vigu (Fatal error jne)
  # 4. Kas vastus pole tühi
  # ============================================
  check-https:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Kui üks ebaõnnestub, jätka teistega
      matrix:
        site:
          - url: https://nirgu.ee
            name: nirgu.ee
            emails: "info@nirgu.ee"
          - url: https://birdbusters.eu
            name: birdbusters.eu
            emails: "info@birdbusters.eu"
          - url: https://sharpy.ee
            name: sharpy.ee
            emails: "info@sharpy.ee"
          - url: http://linnupeletaja.ee  # NB: HTTP, mitte HTTPS (Netpro SSL probleem)
            name: linnupeletaja.ee
            emails: "info@nirgu.ee"
          - url: https://lasteaiapildid.ee
            name: lasteaiapildid.ee
            emails: "info@lasteaiapildid.ee"
          - url: https://athliit.ee
            name: athliit.ee
            emails: "anne.ruusmann@athliit.ee,info@athliit.ee,kerstenkorge@athliit.ee"

    steps:
      - name: Check ${{ matrix.site.name }}
        id: check
        run: |
          error_reason=""
          error_detail=""
          
          # ----------------------------------------
          # 1. LEHE LAADIMINE (timeout 30 sek)
          # ----------------------------------------
          if ! response=$(curl -sL --max-time 30 "${{ matrix.site.url }}" 2>&1); then
            error_reason="Leht ei laadinud 30 sekundi jooksul"
            error_detail="Timeout or connection failed"
          else
            # ----------------------------------------
            # 2. HTTP STAATUSKOODI KONTROLL
            # ----------------------------------------
            status=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 30 "${{ matrix.site.url }}")
            
            if [ "$status" != "200" ]; then
              error_reason="Server tagastas vea"
              error_detail="HTTP status: $status"
            
            # ----------------------------------------
            # 3. PHP VIGADE KONTROLL
            # ----------------------------------------
            elif echo "$response" | grep -qiE "(Fatal error|Parse error|Warning:|Exception)"; then
              error_reason="PHP viga lehel"
              error_detail="Fatal error, Parse error või Warning leitud"
            
            # ----------------------------------------
            # 4. TÜHJA VASTUSE KONTROLL
            # ----------------------------------------
            elif [ ${#response} -lt 500 ]; then
              error_reason="Leht on tühi või liiga lühike"
              error_detail="Response size: ${#response} bytes"
            fi
          fi
          
          # Salvesta tulemused
          if [ -n "$error_reason" ]; then
            echo "error_reason=$error_reason" >> $GITHUB_OUTPUT
            echo "error_detail=$error_detail" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "${{ matrix.site.name }}: OK"

      - name: Send alert email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "⚠️ ${{ matrix.site.name }} probleem"
          to: ${{ env.TEST_MODE == 'true' && env.TECH_EMAIL || format('{0},{1}', matrix.site.emails, env.TECH_EMAIL) }}
          from: Veebilehtede seire
          body: |
            ${{ matrix.site.name }} ei tööta!
            
            Põhjus: ${{ steps.check.outputs.error_reason }}
            Tehniline info: ${{ steps.check.outputs.error_detail }}
            
            Kontrolli lehte: ${{ matrix.site.url }}

  # ============================================
  # SSL KONTROLL - sertifikaadi aegumise jälgimine
  # Hoiatab kui vähem kui 7 päeva jäänud
  # NB: linnupeletaja.ee puudub (Netpro SSL probleem)
  # ============================================
  check-ssl:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        site:
          - host: nirgu.ee
            emails: "info@nirgu.ee"
          - host: birdbusters.eu
            emails: "info@birdbusters.eu"
          - host: sharpy.ee
            emails: "info@sharpy.ee"
          - host: lasteaiapildid.ee
            emails: "info@lasteaiapildid.ee"
          - host: athliit.ee
            emails: "anne.ruusmann@athliit.ee,info@athliit.ee,kerstenkorge@athliit.ee"

    steps:
      - name: Check ${{ matrix.site.host }} SSL
        id: check
        run: |
          expiry=$(echo | openssl s_client -connect ${{ matrix.site.host }}:443 -servername ${{ matrix.site.host }} 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
          expiry_epoch=$(date -d "$expiry" +%s)
          now_epoch=$(date +%s)
          days_left=$(( (expiry_epoch - now_epoch) / 86400 ))
          echo "${{ matrix.site.host }} SSL: $days_left päeva jäänud"
          echo "days_left=$days_left" >> $GITHUB_OUTPUT
          [ $days_left -gt 7 ] || exit 1

      - name: Send alert email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "⚠️ ${{ matrix.site.host }} SSL sertifikaat aegub!"
          to: ${{ env.TEST_MODE == 'true' && env.TECH_EMAIL || format('{0},{1}', matrix.site.emails, env.TECH_EMAIL) }}
          from: Veebilehtede seire
          body: |
            ${{ matrix.site.host }} SSL sertifikaat aegub varsti!
            
            Päevi jäänud: ${{ steps.check.outputs.days_left }}
