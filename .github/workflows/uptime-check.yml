name: Uptime Check

on:
  # schedule:  # DISABLED - kasuta v2
    # - cron: "*/5 * * * *"
  workflow_dispatch:

# ============================================
# SEADISTUS
# ============================================
env:
  TEST_MODE: "false"
  TECH_EMAIL: "ruusmann@gmail.com"

jobs:
  # ============================================
  # HTTPS KONTROLL - kõik lehed ühes kohas
  # 
  # Kontrollib:
  # 1. Kas leht vastab (timeout 30 sek)
  # 2. Kas HTTP staatus on 200
  # 3. Kas lehel pole PHP vigu (ainult PHP lehtedel)
  # 4. Kas vastus pole tühi
  # ============================================
  check-https:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Kui üks ebaõnnestub, jätka teistega
      matrix:
        site:
          - url: https://nirgu.ee
            name: nirgu.ee
            emails: "info@nirgu.ee"
            is_php: true
          - url: https://birdbusters.eu
            name: birdbusters.eu
            emails: "info@birdbusters.eu"
            is_php: true
          - url: https://sharpy.ee
            name: sharpy.ee
            emails: "info@sharpy.ee"
            is_php: true
          - url: http://linnupeletaja.ee  # NB: HTTP, mitte HTTPS (Netpro SSL probleem)
            name: linnupeletaja.ee
            emails: "info@nirgu.ee"
            is_php: true
          - url: https://lasteaiapildid.ee
            name: lasteaiapildid.ee
            emails: "info@lasteaiapildid.ee"
            is_php: false  # Staatiline Astro leht
          - url: https://athliit.ee
            name: athliit.ee
            emails: "anne.ruusmann@athliit.ee,info@athliit.ee,kerstenkorge@athliit.ee"
            is_php: true

    steps:
      - name: Check ${{ matrix.site.name }}
        id: check
        run: |
          site_name="${{ matrix.site.name }}"
          is_php="${{ matrix.site.is_php }}"
          error_reason=""
          error_detail=""
          
          echo "========================================"
          echo "Kontrollin: $site_name"
          echo "========================================"
          
          # ----------------------------------------
          # 1. LEHE LAADIMINE (timeout 30 sek)
          # ----------------------------------------
          if ! response=$(curl -sL --max-time 30 "${{ matrix.site.url }}" 2>&1); then
            error_reason="Leht ei laadinud 30 sekundi jooksul"
            error_detail="Timeout or connection failed"
            echo "❌ $site_name: Timeout"
          else
            echo "✅ $site_name: Leht laadis"
            
            # ----------------------------------------
            # 2. HTTP STAATUSKOODI KONTROLL
            # ----------------------------------------
            status=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 30 "${{ matrix.site.url }}")
            
            if [ "$status" != "200" ]; then
              error_reason="Server tagastas vea"
              error_detail="HTTP status: $status"
              echo "❌ $site_name: HTTP $status"
            else
              echo "✅ $site_name: HTTP $status"
            
              # ----------------------------------------
              # 3. PHP VIGADE KONTROLL (ainult PHP lehtedel)
              # ----------------------------------------
              if [ "$is_php" = "true" ]; then
                if echo "$response" | grep -qiE "(Fatal error|Parse error|Warning:|Exception)"; then
                  error_reason="PHP viga lehel"
                  error_detail="Fatal error, Parse error või Warning leitud"
                  echo "❌ $site_name: PHP viga leitud"
                else
                  echo "✅ $site_name: PHP vigu pole"
                fi
              else
                echo "ℹ️ $site_name: Staatiline leht, PHP kontrolli pole"
              fi
              
              # ----------------------------------------
              # 4. TÜHJA VASTUSE KONTROLL
              # ----------------------------------------
              if [ -z "$error_reason" ]; then
                response_size=${#response}
                if [ $response_size -lt 500 ]; then
                  error_reason="Leht on tühi või liiga lühike"
                  error_detail="Response size: $response_size bytes"
                  echo "❌ $site_name: Vastus liiga lühike ($response_size bytes)"
                else
                  echo "✅ $site_name: Vastus OK ($response_size bytes)"
                fi
              fi
            fi
          fi
          
          echo "========================================"
          
          # Salvesta tulemused
          if [ -n "$error_reason" ]; then
            echo "error_reason=$error_reason" >> $GITHUB_OUTPUT
            echo "error_detail=$error_detail" >> $GITHUB_OUTPUT
            echo "❌ $site_name: EBAÕNNESTUS"
            exit 1
          fi
          
          echo "✅ $site_name: KÕIK OK"

      - name: Send alert email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "⚠️ ${{ matrix.site.name }} probleem"
          to: ${{ env.TEST_MODE == 'true' && env.TECH_EMAIL || format('{0},{1}', matrix.site.emails, env.TECH_EMAIL) }}
          from: Veebilehtede seire
          body: |
            ${{ matrix.site.name }} ei tööta!
            
            Põhjus: ${{ steps.check.outputs.error_reason }}
            Tehniline info: ${{ steps.check.outputs.error_detail }}
            
            Kontrolli lehte: ${{ matrix.site.url }}

  # ============================================
  # SSL KONTROLL - sertifikaadi aegumise jälgimine
  # Hoiatab kui vähem kui 7 päeva jäänud
  # NB: linnupeletaja.ee puudub (Netpro SSL probleem)
  # ============================================
  check-ssl:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        site:
          - host: nirgu.ee
            emails: "info@nirgu.ee"
          - host: birdbusters.eu
            emails: "info@birdbusters.eu"
          - host: sharpy.ee
            emails: "info@sharpy.ee"
          - host: lasteaiapildid.ee
            emails: "info@lasteaiapildid.ee"
          - host: athliit.ee
            emails: "anne.ruusmann@athliit.ee,info@athliit.ee,kerstenkorge@athliit.ee"

    steps:
      - name: Check ${{ matrix.site.host }} SSL
        id: check
        run: |
          site_host="${{ matrix.site.host }}"
          
          echo "========================================"
          echo "SSL kontroll: $site_host"
          echo "========================================"
          
          expiry=$(echo | openssl s_client -connect $site_host:443 -servername $site_host 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
          expiry_epoch=$(date -d "$expiry" +%s)
          now_epoch=$(date +%s)
          days_left=$(( (expiry_epoch - now_epoch) / 86400 ))
          
          echo "days_left=$days_left" >> $GITHUB_OUTPUT
          
          if [ $days_left -gt 7 ]; then
            echo "✅ $site_host: SSL OK ($days_left päeva jäänud)"
          else
            echo "❌ $site_host: SSL aegub! ($days_left päeva jäänud)"
            exit 1
          fi
          
          echo "========================================"

      - name: Send alert email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "⚠️ ${{ matrix.site.host }} SSL sertifikaat aegub!"
          to: ${{ env.TEST_MODE == 'true' && env.TECH_EMAIL || format('{0},{1}', matrix.site.emails, env.TECH_EMAIL) }}
          from: Veebilehtede seire
          body: |
            ${{ matrix.site.host }} SSL sertifikaat aegub varsti!
            
            Päevi jäänud: ${{ steps.check.outputs.days_left }}
