name: Daily Summary

on:
  schedule:
    - cron: "0 8 * * *"  # Iga pÃ¤ev kell 8:00 UTC (10:00 Eesti aeg)
  workflow_dispatch:

jobs:
  summary:
    runs-on: ubuntu-latest
    steps:
      - name: Check all sites and send summary
        env:
          MAIL_TO: ${{ secrets.NOTIFY_EMAIL }}
        run: |
          echo "=== SALU OÃœ veebilehtede pÃ¤evakokkuvÃµte ===" > summary.txt
          echo "KuupÃ¤ev: $(date '+%Y-%m-%d %H:%M UTC')" >> summary.txt
          echo "" >> summary.txt

          check_site() {
            local site=$1
            local skip_ssl=$2

            # HTTPS check
            if [ "$skip_ssl" = "true" ]; then
              status=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 30 -k "https://$site")
            else
              status=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 30 "https://$site")
            fi

            if [ "$status" = "200" ]; then
              https_status="âœ… OK"
            else
              https_status="âŒ PROBLEEM ($status)"
            fi

            # SSL check
            ssl_info=$(echo | openssl s_client -connect "$site:443" -servername "$site" 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
            if [ -n "$ssl_info" ]; then
              expiry_epoch=$(date -d "$ssl_info" +%s 2>/dev/null)
              now_epoch=$(date +%s)
              if [ -n "$expiry_epoch" ]; then
                days_left=$(( (expiry_epoch - now_epoch) / 86400 ))
                if [ $days_left -gt 14 ]; then
                  ssl_status="âœ… OK ($days_left pÃ¤eva)"
                elif [ $days_left -gt 7 ]; then
                  ssl_status="âš ï¸ Aegub varsti ($days_left pÃ¤eva)"
                else
                  ssl_status="âŒ KRIITILINE ($days_left pÃ¤eva)"
                fi
              else
                ssl_status="âŒ Viga"
              fi
            else
              ssl_status="âŒ Sertifikaat puudub/vigane"
            fi

            echo "$site:" >> summary.txt
            echo "  HTTPS: $https_status" >> summary.txt
            echo "  SSL:   $ssl_status" >> summary.txt
            echo "" >> summary.txt
          }

          check_site "nirgu.ee" "false"
          check_site "birdbusters.eu" "false"
          check_site "sharpy.ee" "false"
          check_site "linnupeletaja.ee" "true"

          echo "---" >> summary.txt
          echo "Automaatne kontroll: https://github.com/Anne-dot/upptime-monitor" >> summary.txt

          cat summary.txt

          # Kui email on seadistatud, siis kuva teade
          if [ -n "$MAIL_TO" ]; then
            echo ""
            echo "ðŸ“§ KokkuvÃµte saadetakse aadressile: $MAIL_TO"
          fi
